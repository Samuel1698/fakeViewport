let updateCache={timestamp:0,data:null},lastScriptUptime=null;const CACHE_TTL=9e5;function cmpVersions(t,e){const a=t.split(".").map(Number),n=e.split(".").map(Number);for(let t=0,e=Math.max(a.length,n.length);t<e;t++){const e=a[t]||0,s=n[t]||0;if(e>s)return 1;if(e<s)return-1}return 0}async function loadUpdateData(){const t=Date.now();if(updateCache.data&&t-updateCache.timestamp<CACHE_TTL)return updateCache.data;const[e,a]=await Promise.all([fetchJSON("/update"),fetch("/update/changelog").then((t=>t.json()))]);if(!e?.data)throw new Error("Failed to fetch version info");if("ok"!==a.status)throw new Error("Failed to fetch changelog");const{current:n,latest:s}=e.data,{changelog:o,release_url:r}=a.data;return updateCache={timestamp:t,data:{current:n,latest:s,changelog:o,releaseUrl:r}},updateCache.data}async function checkForUpdate(){try{const{current:t,latest:e}=await loadUpdateData();if(cmpVersions(e,t)<=0)return;const a=document.getElementById("update");a&&a.removeAttribute("hidden")}catch(t){console.error("Update check failed:",t)}}function showChangelog(){const t=updateCache.data;if(!t)return void console.error("No update data; did you call checkForUpdate()?");const{latest:e,changelog:a,releaseUrl:n}=t,s=document.querySelector("#changelog .container h2");e.includes("failed-to-fetch")?s.textContent="Failed to Fetch Changelog":s.textContent=`Release v${e}`,document.getElementById("changelog-body").innerHTML=marked.parse(a),document.getElementById("changelog-link").href=n,document.getElementById("changelog").removeAttribute("hidden")}function formatDuration(t){const e=Math.floor(t/86400),a=Math.floor(t%86400/3600),n=Math.floor(t%3600/60),s=Math.floor(t%60),o=[];return e>0&&o.push(`${e}d`),a>0&&o.push(`${a}h`),n>0&&o.push(`${n}m`),s>0&&o.push(`${s}s`),o.length>0?o.join(" "):"0s"}document.addEventListener("DOMContentLoaded",(()=>{loadInfo(),checkForUpdate(),setInterval(loadInfo,6e4),setInterval(checkForUpdate,CACHE_TTL)})),document.addEventListener("DOMContentLoaded",(()=>{const t={status:document.getElementById("info"),logs:document.getElementById("logs"),updateBanner:document.getElementById("changelog")},e={status:document.getElementById("status"),logs:document.getElementById("logsBtn"),updateBanner:document.getElementById("update"),refreshButton:document.getElementById("refreshButton")},a=document.getElementById("logOutput");function n(a){Object.values(t).forEach((t=>{t.setAttribute("hidden","")})),t[a].removeAttribute("hidden"),Object.entries(e).forEach((([t,e])=>{e.setAttribute("aria-selected",t===a?"true":"false")})),"status"!=a&&e.refreshButton.setAttribute("hidden","true")}t.status.removeAttribute("hidden"),t.logs.setAttribute("hidden",""),t.updateBanner.setAttribute("hidden",""),e.status.setAttribute("aria-selected","true"),e.logs.removeAttribute("aria-selected","false"),e.updateBanner.removeAttribute("aria-selected","false"),e.status.addEventListener("click",(()=>{n("status"),e.refreshButton.removeAttribute("hidden","")})),e.logs.addEventListener("click",(async()=>{n("logs");const t=await fetchJSON("/api/logs?limit=100");t?.data?.logs&&(a.textContent=t.data.logs.join(""))})),pushUpdate=t.updateBanner.querySelector('button[type="submit"]'),pushUpdate.addEventListener("click",(()=>applyUpdate(pushUpdate))),e.updateBanner.addEventListener("click",(()=>{n("updateBanner"),showChangelog()})),e.refreshButton.addEventListener("click",(()=>{n("status"),loadInfo()}))}));const formatter=new Intl.DateTimeFormat("en-US",{month:"short",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1});async function fetchJSON(t){try{const e=await fetch(t);return e.ok?await e.json():null}catch{return null}}async function loadInfo(){const t=await fetchJSON("/api/script_uptime"),e=document.getElementById("scriptUptime");if(t?.data&&"number"==typeof t.data.script_uptime){const a=t.data.script_uptime;e.classList.remove("Green","Red"),null!==lastScriptUptime&&a===lastScriptUptime?(e.textContent="Not Running",e.classList.add("Red")):(e.textContent=formatDuration(a),e.classList.add("Green")),lastScriptUptime=a}else e.textContent="Not Running",e.classList.add("Red"),lastScriptUptime=null;const a=await fetchJSON("/api/system_uptime");a?.data&&(document.getElementById("systemUptime").textContent=formatDuration(a.data.system_uptime));const n=await fetchJSON("/api/ram");if(n?.data){const t=(n.data.ram_used/1024**3).toFixed(1),e=(n.data.ram_total/1024**3).toFixed(1),a=document.getElementById("ram"),s=n.data.ram_used/n.data.ram_total*100;a.textContent=`${t} GiB / ${e} GiB`,a.classList.remove("Green","Yellow","Red"),s<=35?a.classList.add("Green"):s<=60?a.classList.add("Yellow"):a.classList.add("Red")}const s=await fetchJSON("/api/health_interval");if(s?.data){const t=Math.round(s.data.health_interval_sec/60);document.getElementById("healthInterval").textContent=`${t} min`}const o=await fetchJSON("/api/log_interval");o?.data&&(document.getElementById("logInterval").textContent=`${o.data.log_interval_min} min`);const r=await fetchJSON("/api/status");r?.data&&(document.getElementById("statusMsg").textContent=r.data.status);const d=await fetchJSON("/api/log_entry");if(d?.data){const t=document.getElementById("logEntry");t.textContent=d.data.log_entry,t.classList.remove("Green","Blue","Red"),t.textContent.includes("[INFO]")?t.classList.add("Green"):t.textContent.includes("[ERROR]")?t.classList.add("Red"):t.textContent.includes("[DEBUG]")&&t.classList.add("Blue")}const c=await fetchJSON("/api/next_restart"),i=document.getElementById("scheduledRestart");if(c?.data?.next_restart){const t=new Date(c.data.next_restart);i.textContent=formatter.format(t).replace(/, /g," "),i.parentElement.removeAttribute("hidden")}else i.parentElement.setAttribute("hidden","")}async function control(t,e){e.setAttribute("disabled",""),setTimeout((()=>{e.removeAttribute("disabled")}),5e3);const a=document.querySelector("#statusMessage span");a.textContent="",a.classList.remove("Green","Red");try{const e=await fetch(`/api/control/${t}`,{method:"POST"}),n=await e.json();"ok"===n.status?(a.textContent="✓ "+n.message,a.classList.add("Green")):(a.textContent="✗ "+n.message,a.classList.add("Red")),await loadInfo(),setTimeout((()=>{a.textContent="",a.classList.remove("Green","Red")}),5e3),setTimeout(loadInfo,5e3)}catch(t){a.textContent="✗ "+t,a.classList.add("Red")}}async function applyUpdate(t){const e=document.querySelector("#updateMessage span"),a=t.querySelector("span").textContent,n=t.disabled;e.textContent="",e.className="",t.disabled=!0,e.textContent="Fetching Update...",e.classList.add("Green");try{const s=await fetch("/update/apply",{method:"POST"});if(!s.ok)throw new Error(`Update failed with status ${s.status}`);const o=await s.json(),r=o?.data?.outcome||o?.outcome;if("already-current"===r)return e.textContent="✓ Your system is already up to date",e.classList.remove("Red"),e.classList.add("Green"),t.querySelector("span").textContent="Up to date",void setTimeout((()=>{t.querySelector("span").textContent=a,t.disabled=n,e.textContent="",e.className=""}),1e4);if(!r.startsWith("updated-to-"))throw"update-failed"===r?new Error("Update process failed"):new Error("Unexpected update response");e.textContent="✓ Update successful, preparing to restart...",e.classList.remove("Red"),e.classList.add("Green");try{const[a,n]=await Promise.all([fetch("/api/control/restart",{method:"POST"}),fetch("/api/self/restart",{method:"POST"})]);if(!a.ok||!n.ok)throw new Error("Restart commands failed");const[s,o]=await Promise.all([a.json(),n.json()]);"ok"===s.status&&"ok"===o.status?(e.textContent="✓ System restarting...",setTimeout((()=>location.reload()),5e3)):(e.textContent="✓ Update complete - please restart manually",t.querySelector("span").textContent="Restart required")}catch(a){e.textContent="✓ Update complete - automatic restart failed",t.querySelector("span").textContent="Restart required",console.error("Restart failed:",a)}}catch(a){console.error("Update failed:",a),e.classList.remove("Green"),e.classList.add("Red"),a.message.includes("Failed to fetch")?e.textContent="✗ Network error - please check your connection":a.message.includes("Update process failed")?e.textContent="✗ Update failed - please try again":e.textContent="✗ Update error - please check logs",t.querySelector("span").textContent="Retry",t.disabled=!1}}