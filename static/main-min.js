let updateCache={timestamp:0,data:null},lastScriptUptime=null;const CACHE_TTL=36e5;function cmpVersions(t,e){const a=t.split(".").map(Number),n=e.split(".").map(Number);for(let t=0,e=Math.max(a.length,n.length);t<e;t++){const e=a[t]||0,o=n[t]||0;if(e>o)return 1;if(e<o)return-1}return 0}async function loadUpdateData(){const t=Date.now();if(updateCache.data&&t-updateCache.timestamp<CACHE_TTL)return updateCache.data;const[e,a]=await Promise.all([fetchJSON("/update"),fetch("/update/changelog").then((t=>t.json()))]);if(!e?.data)throw new Error("Failed to fetch version info");if("ok"!==a.status)throw new Error("Failed to fetch changelog");const{current:n,latest:o}=e.data,{changelog:d,release_url:r}=a.data;return updateCache={timestamp:t,data:{current:n,latest:o,changelog:d,releaseUrl:r}},updateCache.data}async function checkForUpdate(){try{const{current:t,latest:e}=await loadUpdateData();if(cmpVersions(e,t)<=0)return;const a=document.getElementById("updateBanner");a&&a.removeAttribute("hidden")}catch(t){console.error("Update check failed:",t)}}function showChangelog(){const t=updateCache.data;if(!t)return void console.error("No update data; did you call checkForUpdate()?");const{latest:e,changelog:a,releaseUrl:n}=t;document.querySelector("#changelogModal .container h2").textContent=`Release v${e}`,document.getElementById("changelog-body").innerHTML=marked.parse(a),document.getElementById("changelog-link").href=n,document.getElementById("changelogModal").removeAttribute("hidden")}function formatDuration(t){const e=Math.floor(t/86400),a=Math.floor(t%86400/3600),n=Math.floor(t%3600/60),o=Math.floor(t%60),d=[];return e>0&&d.push(`${e}d`),a>0&&d.push(`${a}h`),n>0&&d.push(`${n}m`),o>0&&d.push(`${o}s`),d.length>0?d.join(" "):"0s"}document.addEventListener("DOMContentLoaded",(()=>{loadInfo(),checkForUpdate(),setInterval(loadInfo,6e4),setInterval(checkForUpdate,CACHE_TTL)}));const formatter=new Intl.DateTimeFormat("en-US",{month:"short",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1});async function fetchJSON(t){try{const e=await fetch(t);return e.ok?await e.json():null}catch{return null}}async function loadInfo(){const t=await fetchJSON("/api/script_uptime"),e=document.getElementById("scriptUptime");if(t?.data&&"number"==typeof t.data.script_uptime){const a=t.data.script_uptime;e.textContent=null!==lastScriptUptime&&a===lastScriptUptime?"Not Running":formatDuration(a),lastScriptUptime=a}else e.textContent="Not Running",lastScriptUptime=null;const a=await fetchJSON("/api/system_uptime");a?.data&&(document.getElementById("systemUptime").textContent=formatDuration(a.data.system_uptime));const n=await fetchJSON("/api/ram");if(n?.data){const t=(n.data.ram_used/1024**3).toFixed(1),e=(n.data.ram_total/1024**3).toFixed(1);document.getElementById("ram").textContent=`${t} GiB / ${e} GiB`}const o=await fetchJSON("/api/health_interval");if(o?.data){const t=Math.round(o.data.health_interval_sec/60);document.getElementById("healthInterval").textContent=`${t} min`}const d=await fetchJSON("/api/log_interval");d?.data&&(document.getElementById("logInterval").textContent=`${d.data.log_interval_min} min`);const r=await fetchJSON("/api/status");r?.data&&(document.getElementById("statusMsg").textContent=r.data.status);const c=await fetchJSON("/api/log_entry");c?.data&&(document.getElementById("logEntry").textContent=c.data.log_entry);const s=await fetchJSON("/api/next_restart"),l=document.getElementById("scheduledRestart");if(s?.data?.next_restart){const t=new Date(s.data.next_restart);l.textContent=formatter.format(t).replace(/, /g," "),l.parentElement.removeAttribute("hidden")}else l.parentElement.setAttribute("hidden","")}async function control(t,e){e.setAttribute("disabled",""),setTimeout((()=>{e.removeAttribute("disabled")}),15e3);const a=document.querySelector("#statusMessage span");a.textContent="",a.style.color="";try{const e=await fetch(`/api/control/${t}`,{method:"POST"}),n=await e.json();"ok"===n.status?(a.textContent="✓ "+n.message,a.style.color="green"):(a.textContent="✗ "+n.message,a.style.color="red"),await loadInfo(),setTimeout((()=>{a.textContent="",a.style.color=""}),15e3),setTimeout(loadInfo,15e3)}catch(t){a.textContent="✗ "+t,a.style.color="red"}}async function applyUpdate(t){t.disabled=!0,t.textContent="Updating…";try{const e=await fetch("/update/apply",{method:"POST"}),a=await e.json();if(t.textContent=a?.data?.outcome?.startsWith("updated")?"Updated - restarting…":"Update failed",a?.data?.outcome?.startsWith("updated")){const t=await fetch("/api/control/restart",{method:"POST"});"ok"===(await t.json()).status&&setTimeout((()=>location.reload()),5e3)}}catch{t.textContent="Update failed"}}const logsBtn=document.getElementById("showLogsBtn"),update=document.getElementById("updateBanner"),output=document.getElementById("logOutput"),modal=document.getElementById("logsModal"),modals=document.querySelectorAll(".modal"),closeBtns=document.querySelectorAll(".close");logsBtn.addEventListener("click",(async()=>{const t=await fetchJSON("/api/logs?limit=100");t?.data?.logs?(output.textContent=t.data.logs.join(""),modal.removeAttribute("hidden")):modal.setAttribute("hidden","")})),update.addEventListener("click",showChangelog),modals.forEach((t=>{t.addEventListener("click",(e=>{e.target===t&&t.setAttribute("hidden","")}))})),closeBtns.forEach((t=>{t.addEventListener("click",(()=>{const e=t.closest(".modal");e&&e.setAttribute("hidden","")}))}));