const show=t=>t.classList.remove("hidden"),hide=t=>t.classList.add("hidden");function formatDuration(t){const e=Math.floor(t/86400),n=Math.floor(t%86400/3600),a=Math.floor(t%3600/60),o=Math.floor(t%60),s=[];return e>0&&s.push(`${e}d`),n>0&&s.push(`${n}h`),a>0&&s.push(`${a}m`),o>0&&s.push(`${o}s`),s.length>0?s.join(" "):"0s"}async function loadInfo(){const t={"X-API-KEY":localStorage.getItem("viewport_api_key")};async function e(e){try{const n=await fetch(e,{headers:t});return n.ok?await n.json():null}catch{return null}}const n=await e("/api/script_uptime");n?.data&&(document.getElementById("scriptUptime").textContent=formatDuration(n.data.script_uptime));const a=await e("/api/system_uptime");a?.data&&(document.getElementById("systemUptime").textContent=formatDuration(a.data.system_uptime));const o=await e("/api/ram");if(o?.data){const t=(o.data.ram_used/1024**3).toFixed(1),e=(o.data.ram_total/1024**3).toFixed(1);document.getElementById("ram").textContent=`${t} GiB / ${e} GiB`}const s=await e("/api/health_interval");if(s?.data){const t=Math.round(s.data.health_interval_sec/60);document.getElementById("healthInterval").textContent=`${t} min`}const i=await e("/api/log_interval");i?.data&&(document.getElementById("logInterval").textContent=`${i.data.log_interval_min} min`);const d=await e("/api/status");d?.data&&(document.getElementById("statusMsg").textContent=d.data.status);const l=await e("/api/log_entry");l?.data&&(document.getElementById("logEntry").textContent=l.data.log_entry)}async function control(t){const e=document.getElementById("statusMessage");e.textContent="";const n=localStorage.getItem("viewport_api_key");if(!n)return e.textContent="✗ No API key saved",void(e.style.color="red");try{const a=await fetch(`/api/control/${t}`,{method:"POST",headers:{"X-API-KEY":n}}),o=await a.json();"ok"===o.status?(e.textContent="✓ "+o.message,e.style.color="green"):(e.textContent="✗ "+o.message,e.style.color="red")}catch(t){e.textContent="✗ "+t,e.style.color="red"}}document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("login"),e=document.getElementById("controls"),n=document.getElementById("info"),a=document.getElementById("saveKey"),o=document.getElementById("apiKeyInput");hide(e),hide(n),show(t);const s="undefined"!=typeof CONTROL_TOKEN&&CONTROL_TOKEN.trim().length>0,i=localStorage.getItem("viewport_api_key")?.trim().length>0;(s||i)&&(hide(t),show(e),show(n),loadInfo()),a.addEventListener("click",(()=>{const a=o.value.trim();a?(localStorage.setItem("viewport_api_key",a),hide(t),show(e),show(n),loadInfo()):alert("API key cannot be empty")})),setInterval((()=>{n.classList.contains("hidden")||loadInfo()}),6e4)}));